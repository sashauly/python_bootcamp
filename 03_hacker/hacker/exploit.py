import os
from bs4 import BeautifulSoup


def exploit(file_path):
    with open(file_path, 'r') as f:
        page = f.read()
        soup = BeautifulSoup(page, 'html.parser')

    soup.title.string = 'Evil Corp - Stealing your money every day'

    name_span = soup.find('span', {'class': 'name'})
    pronoun_span = name_span.find('span', {'class': 'pronoun'})
    h1_tag = soup.new_tag("h1")
    h1_tag.string = f"{pronoun_span.text}{name_span.text.replace(pronoun_span.text, '').strip()}, you are hacked!"
    soup.body.insert(0, h1_tag)

    trenton_script = """
    <script>
        hacked = function() {
            alert('hacked');
        }
        window.addEventListener('load',
          function() {
            var f = document.querySelector("form");
            f.setAttribute("onsubmit", "hacked()");
          },
          false
        );
    </script>
    """
    soup.body.append(BeautifulSoup(trenton_script, 'html.parser'))

    link_tag = soup.find(href="https://mrrobot.fandom.com/wiki/E_Corp")
    link_tag['href'] = "https://mrrobot.fandom.com/wiki/Fsociety"
    link_tag.string = "Fsociety"

    dir_name = os.path.dirname(file_path)
    output_file_path = os.path.join(dir_name, 'evilcorp_hacked.html')
    with open(output_file_path, 'w') as f:
        f.write(str(soup.prettify()))


if __name__ == '__main__':
    evilcorp_file_path = '../materials/evilcorp.html'
    exploit(evilcorp_file_path)
